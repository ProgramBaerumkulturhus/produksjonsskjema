<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Produksjonsskjema</title>

  <!-- Anbefalt: ha style.css ved siden av denne fila -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h2 id="title">Lasterâ€¦</h2>

  <table id="data">
    <tr>
      <th>Dato</th>
      <th>Inn-tid</th>
      <th>Ut-tid</th>
      <th>Aktivitet</th>
    </tr>
  </table>

  <button id="saveBtn">ðŸ’¾ Lagre endringer</button>
  <span id="lastSaved"></span>
  <div id="toast" class="toast">âœ… Endringer lagret!</div>

  <script>
    // ---------- KONFIG ----------
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwhFCFI7GTThEzfPY37xxU9WTT3fyJTgY-Q-3utJFYYIcz5yeb-lrpYYpQ9qe24Tk1i8Q/exec"; // <-- DIN /exec-URL
    const params = new URLSearchParams(window.location.search);
    const ark = params.get("ark") || "";

    const aktivitetValg = [
      "â€”",
      "Rigg",
      "PrÃ¸ver",
      "Forestilling",
      "Forestilling x2",
      "Forestilling x3",
      "Spillefri",
      "Annet"
    ];

    // ---------- REFERANSER ----------
    const titleEl = document.getElementById("title");
    const tableEl = document.getElementById("data");
    const saveBtn = document.getElementById("saveBtn");
    const lastSavedEl = document.getElementById("lastSaved");
    const toastEl = document.getElementById("toast");

    // ---------- HJELP ----------
    function fmtDato(d) {
      // viser "ons. 01.10."
      return d.toLocaleDateString("no-NO", {
        weekday: "short",
        day: "2-digit",
        month: "2-digit"
      });
    }

    function isWeekend(d) {
      const day = d.getDay();
      return day === 0 || day === 6; // sÃ¸n/lÃ¸r
    }

    function optionHtml(current) {
      return aktivitetValg
        .map(v => {
          const sel = (v || "") === (current || "") ? "selected" : "";
          const cls = "activity-" + v.toLowerCase().replaceAll(" ", "").replace("â€”", "");
          return `<option value="${v}" class="${cls}" ${sel}>${v}</option>`;
        })
        .join("");
    }

    // ---------- LAST DATA ----------
    async function loadData() {
      if (!ark) {
        titleEl.textContent = "Mangler ?ark= i URL";
        return;
      }
      titleEl.textContent = ark;

      try {
        const res = await fetch(`${SCRIPT_URL}?ark=${encodeURIComponent(ark)}`, {
          method: "GET",
          mode: "cors",
        });
        if (!res.ok) throw new Error(`GET feilet: ${res.status}`);
        const json = await res.json();

        json.rows.forEach((r, i) => {
          // r.dato kan vÃ¦re string fra Apps Script â€“ prÃ¸v Ã¥ lage Date
          const d = new Date(r.dato);
          const tr = document.createElement("tr");
          if (isWeekend(d)) tr.classList.add("weekend");

          tr.innerHTML = `
            <td><input type="text" value="${fmtDato(d)}" readonly></td>
            <td><input type="text" id="inntid-${i}" value="${r.inntid || ""}"></td>
            <td><input type="text" id="uttid-${i}" value="${r.uttid || ""}"></td>
            <td>
              <select id="aktivitet-${i}">
                ${optionHtml(r.aktivitet)}
              </select>
            </td>
          `;
          tableEl.appendChild(tr);
        });

      } catch (err) {
        console.error(err);
        alert("Kunne ikke hente data fra arket. Sjekk API-lenken.");
      }
    }

    // ---------- LAGRE ----------
    async function saveData() {
      try {
        saveBtn.textContent = "â³ Lagrerâ€¦";
        saveBtn.disabled = true;

        const rows = [];
        document.querySelectorAll("input[id^='inntid-']").forEach(inp => {
          const i = inp.id.split("-")[1]; // index fra rad bygd i load
          rows.push({
            row: parseInt(i, 10) + 2, // +2: header i Sheets
            inntid: document.getElementById(`inntid-${i}`).value,
            uttid: document.getElementById(`uttid-${i}`).value,
            aktivitet: document.getElementById(`aktivitet-${i}`).value
          });
        });

        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "cors", // viktig for CORS-flyt
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ark, rows })
        });

        if (!res.ok) throw new Error(`POST feilet: ${res.status}`);
        const txt = await res.text();
        if (!/^OK/i.test(txt)) {
          console.warn("API svarte:", txt);
        }

        saveBtn.textContent = "âœ… Lagret";
        toastEl.classList.add("show");
        const now = new Date().toLocaleTimeString("no-NO", { hour: "2-digit", minute: "2-digit" });
        lastSavedEl.textContent = "Sist lagret: " + now;

        setTimeout(() => {
          toastEl.classList.remove("show");
          saveBtn.textContent = "ðŸ’¾ Lagre endringer";
          saveBtn.disabled = false;
        }, 2000);
      } catch (err) {
        console.error(err);
        saveBtn.textContent = "âš ï¸ Feil ved lagring";
        setTimeout(() => {
          saveBtn.textContent = "ðŸ’¾ Lagre endringer";
          saveBtn.disabled = false;
        }, 2500);
      }
    }

    // ---------- LIM INN FLERE CELLER ----------
    document.querySelector("#data").addEventListener("paste", function (e) {
      const active = document.activeElement;
      if (!active || active.tagName !== "INPUT") return;

      const paste = (e.clipboardData || window.clipboardData).getData("text");
      const lines = paste.trim().split(/\r?\n/).map(l => l.split(/\t/));

      if (lines.length === 1 && lines[0].length === 1) return; // vanlig lim-inn

      e.preventDefault();

      const tr = active.closest("tr");
      const rowIndex = [...tr.parentNode.children].indexOf(tr);
      const allInputs = Array.from(tr.querySelectorAll("input, select"));
      const colIndex = allInputs.indexOf(active);

      lines.forEach((rowVals, i) => {
        const row = document.querySelectorAll("#data tr")[rowIndex + i];
        if (!row) return;
        const inputs = row.querySelectorAll("input, select");
        rowVals.forEach((val, j) => {
          if (inputs[colIndex + j]) inputs[colIndex + j].value = val.trim();
        });
      });
    });

    // ---------- INIT ----------
    saveBtn.addEventListener("click", saveData);
    loadData();
  </script>
</body>
</html>

