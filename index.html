<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <title>Produksjonsskjema</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2 id="title">Laster...</h2>
  <table id="data">
    <tr><th>Dato</th><th>Inn-tid</th><th>Ut-tid</th><th>Aktivitet</th></tr>
  </table>

  <button id="saveBtn">ðŸ’¾ Lagre endringer</button>
  <span id="lastSaved"></span>
  <div id="toast" class="toast">âœ… Endringer lagret!</div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const ark = params.get("ark");
    const apiBase = "https://script.google.com/macros/s/AKfycbwhFCFI7GTThEzfPY37xxU9WTT3fyJTgY-Q-3utJFYYIcz5yeb-lrpYYpQ9qe24Tk1i8Q/exec"; // <-- din backend-url

    const table = document.getElementById("data");
    const title = document.getElementById("title");
    const saveBtn = document.getElementById("saveBtn");
    const lastSaved = document.getElementById("lastSaved");
    const toast = document.getElementById("toast");

    async function loadData() {
      title.textContent = "Laster skjema...";
      const res = await fetch(`${apiBase}?ark=${encodeURIComponent(ark)}`);
      const json = await res.json();

      title.textContent = ark;
      json.rows.forEach((r, i) => {
        const d = new Date(r.dato);
        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
        const row = document.createElement("tr");
        if (isWeekend) row.classList.add("weekend");

        row.innerHTML = `
          <td><input type="text" value="${new Date(r.dato).toLocaleDateString('no-NO', { weekday: 'short', day: '2-digit', month: '2-digit' })}" readonly></td>
          <td><input type="text" id="inntid-${i}" value="${r.inntid || ''}"></td>
          <td><input type="text" id="uttid-${i}" value="${r.uttid || ''}"></td>
          <td>
            <select id="aktivitet-${i}">
              <option value="">â€”</option>
              <option>Rigg</option>
              <option>PrÃ¸ver</option>
              <option>Forestilling</option>
              <option>Forestilling x2</option>
              <option>Forestilling x3</option>
              <option>Spillefri</option>
              <option>Annet</option>
            </select>
          </td>`;
        table.appendChild(row);
        if (r.aktivitet) document.getElementById(`aktivitet-${i}`).value = r.aktivitet;
      });
    }

    saveBtn.addEventListener("click", async () => {
      saveBtn.textContent = "â³ Lagrer...";
      saveBtn.disabled = true;

      const rows = [];
      document.querySelectorAll("input[id^='inntid-']").forEach(inp => {
        const i = inp.id.split('-')[1];
        rows.push({
          row: parseInt(i) + 2,
          inntid: document.getElementById(`inntid-${i}`).value,
          uttid: document.getElementById(`uttid-${i}`).value,
          aktivitet: document.getElementById(`aktivitet-${i}`).value
        });
      });

      await fetch(apiBase, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ark, rows })
      });

      saveBtn.textContent = "âœ… Lagret";
      toast.classList.add("show");
      const now = new Date().toLocaleTimeString("no-NO", { hour: "2-digit", minute: "2-digit" });
      lastSaved.textContent = "Sist lagret: " + now;
      setTimeout(() => {
        toast.classList.remove("show");
        saveBtn.textContent = "ðŸ’¾ Lagre endringer";
        saveBtn.disabled = false;
      }, 3000);
    });

    loadData();
  </script>
</body>
</html>
