<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Produksjonsskjema</title>

  <!-- Anbefalt: ha style.css ved siden av denne fila -->
  <link rel="stylesheet" href="style.css?v=4" />
</head>
<body>

  <header class="intro">
  <h1>Produksjonsskjema</h1>

  <p>I skjema under skal dere fylle ut <strong>inn- og ut-tid</strong> og <strong>innhold</strong> for dagene i leieforholdet.</p>
  <p>Vi ønsker at dere fyller inn tider selv om dette ikke er helt fastsatt enda – vi bruker denne informasjonen som et utgangspunkt for å lage tilbud til dere. Detaljene er <em>ikke bindende</em> og kan endres senere.</p>

  <ul class="bullets">
    <li><strong>Inn-tid</strong> = Første person inn</li>
    <li><strong>Ut-tid</strong> = Siste person ut</li>
  </ul>

  <div class="hint">HUSK Å LAGRE ENDRINGENE NÅR DE ER LAGT INN!</div>
</header>

  <h2 id="title">Laster…</h2>

  <table id="data">
    <tr>
      <th>Dato</th>
      <th>Inn-tid</th>
      <th>Ut-tid</th>
      <th>Aktivitet</th>
    </tr>
  </table>

  <button id="saveBtn">💾 Lagre endringer</button>
  <span id="lastSaved"></span>
  <div id="toast" class="toast">✅ Endringer lagret!</div>

  <script>
    // ---------- KONFIG ----------
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwhFCFI7GTThEzfPY37xxU9WTT3fyJTgY-Q-3utJFYYIcz5yeb-lrpYYpQ9qe24Tk1i8Q/exec"; // <-- DIN /exec-URL
    const params = new URLSearchParams(window.location.search);
    const ark = params.get("ark") || "";

    const aktivitetValg = [
      "—",
      "Rigg",
      "Prøver",
      "Forestilling",
      "Forestilling x2",
      "Forestilling x3",
      "Spillefri",
      "Annet"
    ];

    // ---------- REFERANSER ----------
    const titleEl = document.getElementById("title");
    const tableEl = document.getElementById("data");
    const saveBtn = document.getElementById("saveBtn");
    const lastSavedEl = document.getElementById("lastSaved");
    const toastEl = document.getElementById("toast");

    // ---------- HJELP ----------
    function capitalizeFirst(str) {
  return str ? str.charAt(0).toUpperCase() + str.slice(1) : str;
}
function formatDatoLang(d) {
  const s = d.toLocaleDateString("no-NO", {
    weekday: "long",
    day: "2-digit",
    month: "long"
  });
  return capitalizeFirst(s);
}


    function isWeekend(d) {
      const day = d.getDay();
      return day === 0 || day === 6; // søn/lør
    }

    function optionHtml(current) {
      return aktivitetValg
        .map(v => {
          const sel = (v || "") === (current || "") ? "selected" : "";
          const cls = "activity-" + v.toLowerCase().replaceAll(" ", "").replace("—", "");
          return `<option value="${v}" class="${cls}" ${sel}>${v}</option>`;
        })
        .join("");
    }

    const activityClassMap = {
  "Rigg": "rigg",
  "Prøver": "prøver",
  "Forestilling": "forestilling",
  "Forestilling x2": "forestillingx2",
  "Forestilling x3": "forestillingx3",
  "Spillefri": "spillefri",
  "Annet": "annet",
  "—": ""
};

function applyActivityStyle(selectEl) {
  const td = selectEl.closest("td");
  td.className = "act-cell";     // reset
  selectEl.className = "";       // reset
  const cls = activityClassMap[selectEl.value] || "";
  if (cls) {
    td.classList.add(cls);
    selectEl.classList.add(cls);
  }
}

    
    // ---------- LAST DATA ----------
    async function loadData() {
      if (!ark) {
        titleEl.textContent = "Mangler ?ark= i URL";
        return;
      }
      titleEl.textContent = ark;

      try {
        const res = await fetch(`${SCRIPT_URL}?ark=${encodeURIComponent(ark)}`, {
          method: "GET",
          mode: "cors",
        });
        if (!res.ok) throw new Error(`GET feilet: ${res.status}`);
        const json = await res.json();

      json.rows.forEach((r, i) => {
  const raw = r.dato || "";
  let d = new Date(raw);
  let visDato;
  let weekend = false;

  if (isNaN(d.getTime())) {
    // Klarte ikke tolke – bruk teksten og sjekk helg via prefix
    visDato = raw;
    const lower = raw.toLowerCase();
    weekend = lower.startsWith("lørdag") || lower.startsWith("søndag");
  } else {
    visDato = formatDatoLang(d);   // bruker funksjonen din som lager full ukedag
    weekend = isWeekend(d);
  }

  const tr = document.createElement("tr");
  if (weekend) tr.classList.add("weekend");

  tr.innerHTML = `
    <td><input type="text" value="${visDato}" readonly></td>
    <td><input type="text" id="inntid-${i}" value="${r.inntid || ""}"></td>
    <td><input type="text" id="uttid-${i}" value="${r.uttid || ""}"></td>
    <td class="act-cell">
      <select id="aktivitet-${i}">
        ${optionHtml(r.aktivitet)}
      </select>
    </td>
  `;
  tableEl.appendChild(tr);

  const sel = tr.querySelector(`#aktivitet-${i}`);
  applyActivityStyle(sel);
  sel.addEventListener("change", () => applyActivityStyle(sel));
});



      } catch (err) {
        console.error(err);
        alert("Kunne ikke hente data fra arket. Sjekk API-lenken.");
      }
    }

    // ---------- LAGRE ----------
    async function saveData() {
  saveBtn.textContent = "⏳ Lagrer…";
  saveBtn.disabled = true;

  const rows = [];
  document.querySelectorAll("input[id^='inntid-']").forEach(inp => {
    const i = inp.id.split("-")[1];
    rows.push({
      row: parseInt(i, 10) + 2,
      inntid: document.getElementById(`inntid-${i}`).value,
      uttid: document.getElementById(`uttid-${i}`).value,
      aktivitet: document.getElementById(`aktivitet-${i}`).value
    });
  });

  try {
    // Viktig: text/plain og no-cors => ingen preflight, og vi bryr oss ikke om svar-innhold
    await fetch(SCRIPT_URL, {
      method: "POST",
      mode: "no-cors", // <- gjør requesten “opaque”, ingen CORS-feil i UI
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ ark, rows })
    });

    // Anta suksess (request ble sendt). Gi god UX:
    saveBtn.textContent = "✅ Lagret";
    toastEl.classList.add("show");
    const now = new Date().toLocaleTimeString("no-NO", { hour: "2-digit", minute: "2-digit" });
    lastSavedEl.textContent = "Sist lagret: " + now;
  } catch (err) {
    console.error(err);
    saveBtn.textContent = "⚠️ Feil ved lagring";
  } finally {
    setTimeout(() => {
      toastEl.classList.remove("show");
      saveBtn.textContent = "💾 Lagre endringer";
      saveBtn.disabled = false;
    }, 2000);
  }
}

    // ---------- LIM INN FLERE CELLER ----------
   document.querySelector("#data").addEventListener("paste", function (e) {
  const active = document.activeElement;
  if (!active || (active.tagName !== "INPUT" && active.tagName !== "SELECT")) return;

  const paste = (e.clipboardData || window.clipboardData).getData("text");
  const lines = paste.trim().split(/\r?\n/).map(l => l.split(/\t/));

  if (lines.length === 1 && lines[0].length === 1) return; // vanlig lim-inn

  e.preventDefault();

  const tr = active.closest("tr");
  const rowIndex = [...tr.parentNode.children].indexOf(tr);
  const startCol = [...tr.querySelectorAll("td")].findIndex(td => td.contains(active));

  lines.forEach((rowVals, i) => {
    const row = document.querySelectorAll("#data tr")[rowIndex + i];
    if (!row) return;

    const fields = [
      row.querySelector("td:nth-child(1) input[readonly]"),
      row.querySelector("td:nth-child(2) input"),
      row.querySelector("td:nth-child(3) input"),
      row.querySelector("td:nth-child(4) select")
    ];

    rowVals.forEach((val, j) => {
      const target = fields[startCol + j];
      if (!target) return;

      if (target.tagName === "SELECT") {
        const clean = val.trim();
        const idx = aktivitetValg.findIndex(v => v.toLowerCase() === clean.toLowerCase());
        target.value = idx >= 0 ? aktivitetValg[idx] : clean; // fallback: sett teksten
        applyActivityStyle(target);
      } else {
        target.value = val.trim();
      }
    });
  });
});


    // ---------- INIT ----------
    saveBtn.addEventListener("click", saveData);
    loadData();
  </script>
</body>
</html>

